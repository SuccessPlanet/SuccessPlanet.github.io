<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRUST Report</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      @page {
        size: A4;
        margin: 0;
      }

      body {
        font-family: "Arial", "Helvetica", sans-serif;
        background: #fff;
        color: #1a1a1a;
        line-height: 1.6;
        margin: 0;
        padding: 0;
      }

      .page {
        width: 210mm;
        min-height: 297mm;
        padding: 20mm;
        padding-bottom: 50mm;
        margin: 0 auto 20px;
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        page-break-after: always;
        position: relative;
      }

      @media print {
        @page {
          size: A4;
          margin: 0;
        }

        body {
          background: white;
          margin: 0;
          padding: 0;
        }

        .page {
          width: 210mm;
          min-height: auto;
          margin: 0;
          padding: 20mm;
          padding-bottom: 50mm;
          box-shadow: none;
          page-break-after: always;
          page-break-inside: auto;
          overflow: visible;
        }

        /* Prevent specific elements from breaking across pages */
        .two-column,
        .chart-container,
        .chart-wrapper {
          page-break-inside: avoid;
        }

        /* Allow tables to break across pages naturally */
        .data-table {
          page-break-inside: auto;
        }

        /* Prevent individual rows from breaking */
        .data-table tr {
          page-break-inside: avoid;
          page-break-after: auto;
        }

        /* Repeat table headers on each page */
        .data-table thead {
          display: table-header-group;
        }

        /* Ensure header row doesn't break */
        .data-table thead tr {
          page-break-inside: avoid;
          page-break-after: avoid;
        }

        /* Allow tbody to break across pages */
        .data-table tbody {
          display: table-row-group;
        }

        /* Prevent section titles from being orphaned */
        .section-title {
          page-break-after: avoid;
        }
      }

      /* Header Styles */
      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
      }

      .report-title {
        font-size: 32px;
        font-weight: bold;
        font-style: italic;
        color: #1e40af;
      }

      .report-title .trust {
        color: #2563eb;
      }

      .report-title .report {
        color: #1e40af;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
      }

      .logo img {
        height: 80px;
        width: auto;
        max-width: 150px;
      }

      .logo .tap {
        color: #1e40af;
        text-decoration: underline;
        text-decoration-color: #1e40af;
      }

      .logo .fin {
        color: #10b981;
      }

      /* Cover Page */
      .cover-page {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        min-height: 257mm;
        text-align: center;
        position: relative;
      }

      .cover-title {
        font-size: 72px;
        font-weight: bold;
        font-style: italic;
        margin: 100px 0 20px;
      }

      .cover-title .trust {
        color: #3b82f6;
      }

      .cover-title .report {
        color: #1e40af;
      }

      .cover-date {
        font-size: 24px;
        color: #10b981;
        margin-bottom: 50px;
      }

      .geometric-shapes {
        width: 100%;
        height: 300px;
        position: relative;
        margin-top: auto;
      }

      .shape {
        position: absolute;
        opacity: 0.8;
      }

      .shape-blue {
        background: #3b82f6;
      }

      .shape-green {
        background: #10b981;
      }

      .shape-gray {
        border: 2px solid #d1d5db;
        background: transparent;
      }

      /* Table of Contents */
      .toc-title {
        font-size: 24px;
        font-weight: bold;
        color: #1e40af;
        margin-bottom: 20px;
      }

      .toc-table {
        width: 100%;
        border-collapse: collapse;
      }

      .toc-table th {
        background: #f3f4f6;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #d1d5db;
        font-weight: bold;
        color: #1a1a1a;
      }

      .toc-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .toc-table tr:hover {
        background: #f9fafb;
      }

      /* Section Styles */
      .section-title {
        font-size: 20px;
        font-weight: bold;
        color: #1e40af;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-total {
        font-size: 24px;
        font-weight: bold;
        color: #1a1a1a;
      }

      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .chart-container {
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 16px;
        font-weight: bold;
        color: #1e40af;
        margin-bottom: 15px;
      }

      .chart-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
      }

      /* Table Styles */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        font-size: 12px;
      }

      .data-table th {
        background: #f3f4f6;
        padding: 10px 8px;
        text-align: center;
        font-weight: bold;
        border: 1px solid #d1d5db;
        color: #1a1a1a;
      }

      .data-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }

      .data-table tr:nth-child(even) {
        background: #f9fafb;
      }

      .data-table .sub-header {
        background: #e5e7eb;
        font-weight: bold;
      }

      .data-table .risk-high {
        color: #dc2626;
        font-weight: bold;
      }

      .data-table .risk-medium {
        color: #f59e0b;
        font-weight: bold;
      }

      .data-table .risk-low {
        color: #10b981;
        font-weight: bold;
      }

      .color-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
        vertical-align: middle;
      }

      /* Footer */
      .page-footer {
        position: absolute;
        bottom: 15mm;
        left: 20mm;
        right: 20mm;
        width: calc(100% - 40mm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: #6b7280;
        padding: 0;
      }

      @media print {
        .page-footer {
          position: fixed;
          bottom: 15mm;
          left: 20mm;
          right: 20mm;
          width: calc(100% - 40mm);
        }
      }

      .page-footer > div {
        flex: 1;
        min-width: 0;
      }

      .page-footer > div:first-child {
        text-align: left;
      }

      .page-footer > div:last-child {
        text-align: right;
      }

      .page-footer > div:nth-child(2) {
        text-align: center;
      }

      .page-number {
        text-align: right;
      }

      /* Risk Section */
      .risk-section {
        margin-bottom: 40px;
      }

      .risk-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .risk-header.high {
        color: #dc2626;
      }

      .risk-header.medium {
        color: #f59e0b;
      }

      .risk-header.low {
        color: #10b981;
      }

      .risk-count {
        font-size: 14px;
        color: #6b7280;
        font-weight: normal;
      }

      /* Portfolio Value Section */
      .portfolio-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      /* Line Chart Container */
      .line-chart-container {
        margin-bottom: 30px;
      }

      .line-chart-wrapper {
        margin-bottom: 20px;
      }

      .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 10px;
        font-size: 12px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
    </style>
  </head>
  <body>
    <div id="report-container"></div>

    <script>
      // Chart rendering functions using SVG (no external dependencies)

      function createPieChart(data, colors, size = 200) {
        const total = data.reduce((sum, val) => sum + val, 0);
        if (total === 0)
          return '<svg width="' + size + '" height="' + size + '"></svg>';

        let currentAngle = -90;
        const radius = size / 2 - 10;
        const center = size / 2;
        const slices = [];

        data.forEach((value, index) => {
          const percentage = (value / total) * 100;
          const angle = (value / total) * 360;

          if (value > 0) {
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;

            const x1 = center + radius * Math.cos((startAngle * Math.PI) / 180);
            const y1 = center + radius * Math.sin((startAngle * Math.PI) / 180);
            const x2 = center + radius * Math.cos((endAngle * Math.PI) / 180);
            const y2 = center + radius * Math.sin((endAngle * Math.PI) / 180);

            const largeArc = angle > 180 ? 1 : 0;

            const path = `M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;

            slices.push({
              path,
              color: colors[index] || "#cccccc",
              percentage,
              value,
              midAngle: currentAngle + angle / 2,
            });

            currentAngle += angle;
          }
        });

        // Create SVG
        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;

        slices.forEach((slice) => {
          svg += `<path d="${slice.path}" fill="${slice.color}" stroke="#fff" stroke-width="2"/>`;

          // Add percentage label
          if (slice.percentage > 5) {
            const labelX =
              center +
              radius * 0.7 * Math.cos((slice.midAngle * Math.PI) / 180);
            const labelY =
              center +
              radius * 0.7 * Math.sin((slice.midAngle * Math.PI) / 180);
            svg += `<text x="${labelX}" y="${labelY}" text-anchor="middle" dominant-baseline="middle" font-size="12" font-weight="bold" fill="#fff">${slice.percentage.toFixed(
              1
            )}%</text>`;
          }
        });

        svg += "</svg>";
        return svg;
      }

      function createDonutChart(
        data,
        colors,
        size = 200,
        donutSize = 0.6,
        showCenterText = false
      ) {
        const total = data.reduce((sum, val) => sum + val, 0);
        if (total === 0)
          return '<svg width="' + size + '" height="' + size + '"></svg>';

        let currentAngle = -90;
        const outerRadius = size / 2 - 10;
        const innerRadius = outerRadius * donutSize;
        const center = size / 2;
        const slices = [];

        data.forEach((value, index) => {
          const percentage = (value / total) * 100;
          const angle = (value / total) * 360;

          if (value > 0) {
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;

            const x1o =
              center + outerRadius * Math.cos((startAngle * Math.PI) / 180);
            const y1o =
              center + outerRadius * Math.sin((startAngle * Math.PI) / 180);
            const x2o =
              center + outerRadius * Math.cos((endAngle * Math.PI) / 180);
            const y2o =
              center + outerRadius * Math.sin((endAngle * Math.PI) / 180);

            const x1i =
              center + innerRadius * Math.cos((endAngle * Math.PI) / 180);
            const y1i =
              center + innerRadius * Math.sin((endAngle * Math.PI) / 180);
            const x2i =
              center + innerRadius * Math.cos((startAngle * Math.PI) / 180);
            const y2i =
              center + innerRadius * Math.sin((startAngle * Math.PI) / 180);

            const largeArc = angle > 180 ? 1 : 0;

            const path = `M ${x1o} ${y1o} A ${outerRadius} ${outerRadius} 0 ${largeArc} 1 ${x2o} ${y2o} L ${x1i} ${y1i} A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x2i} ${y2i} Z`;

            slices.push({
              path,
              color: colors[index] || "#cccccc",
              percentage,
              value,
              midAngle: currentAngle + angle / 2,
            });

            currentAngle += angle;
          }
        });

        let svg = `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;

        slices.forEach((slice) => {
          svg += `<path d="${slice.path}" fill="${slice.color}" stroke="#fff" stroke-width="1.5"/>`;

          if (slice.percentage > 5) {
            const labelX =
              center +
              ((outerRadius + innerRadius) / 2) *
                Math.cos((slice.midAngle * Math.PI) / 180);
            const labelY =
              center +
              ((outerRadius + innerRadius) / 2) *
                Math.sin((slice.midAngle * Math.PI) / 180);
            svg += `<text x="${labelX}" y="${labelY}" text-anchor="middle" dominant-baseline="middle" font-size="11" font-weight="bold" fill="#fff">${slice.percentage.toFixed(
              0
            )}%</text>`;
          }
        });

        // Only show center text if explicitly requested (for backward compatibility)
        if (showCenterText) {
          svg += `<text x="${center}" y="${
            center + 5
          }" text-anchor="middle" font-size="16" font-weight="bold" fill="#1a1a1a">100</text>`;
        }

        svg += "</svg>";
        return svg;
      }

      function createLineChart(data, colors, width = 600, height = 300) {
        const { labels, series } = data;
        if (!labels || !series || series.length === 0)
          return '<svg width="' + width + '" height="' + height + '"></svg>';

        const padding = { top: 40, right: 40, bottom: 40, left: 60 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        // Find min and max values
        let min = Infinity;
        let max = -Infinity;
        series.forEach((s) => {
          s.data.forEach((v) => {
            if (v < min) min = v;
            if (v > max) max = v;
          });
        });

        const range = max - min || 1;
        const stepX = chartWidth / (labels.length - 1 || 1);
        const stepY = chartHeight / range;

        let svg = `<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;

        // Grid lines
        const gridLines = 5;
        for (let i = 0; i <= gridLines; i++) {
          const y = padding.top + (chartHeight / gridLines) * i;
          const value = max - (range / gridLines) * i;
          svg += `<line x1="${padding.left}" y1="${y}" x2="${
            width - padding.right
          }" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
          svg += `<text x="${padding.left - 10}" y="${
            y + 4
          }" text-anchor="end" font-size="10" fill="#6b7280">${Math.round(
            value
          )}</text>`;
        }

        // X-axis labels
        labels.forEach((label, i) => {
          const x = padding.left + stepX * i;
          svg += `<line x1="${x}" y1="${padding.top}" x2="${x}" y2="${
            height - padding.bottom
          }" stroke="#e5e7eb" stroke-width="1"/>`;
          svg += `<text x="${x}" y="${
            height - padding.bottom + 20
          }" text-anchor="middle" font-size="10" fill="#6b7280">${label}</text>`;
        });

        // Draw lines
        series.forEach((s, seriesIndex) => {
          const points = s.data.map((value, i) => {
            const x = padding.left + stepX * i;
            const y = padding.top + chartHeight - (value - min) * stepY;
            return { x, y, value };
          });

          // Draw line
          let path = `M ${points[0].x} ${points[0].y}`;
          for (let i = 1; i < points.length; i++) {
            path += ` L ${points[i].x} ${points[i].y}`;
          }

          svg += `<path d="${path}" fill="none" stroke="${
            s.color || colors[seriesIndex]
          }" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;

          // Draw points
          points.forEach((point) => {
            svg += `<circle cx="${point.x}" cy="${point.y}" r="4" fill="${
              s.color || colors[seriesIndex]
            }" stroke="#fff" stroke-width="2"/>`;
          });
        });

        svg += "</svg>";
        return svg;
      }

      // Utility functions
      function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) return "-";
        if (value >= 10000000) {
          return "₹" + (value / 10000000).toFixed(2) + " Cr";
        } else if (value >= 100000) {
          return "₹" + (value / 100000).toFixed(2) + " L";
        }
        return "₹" + value.toFixed(2);
      }

      function formatPercentage(value) {
        if (
          value === null ||
          value === undefined ||
          value === "" ||
          value === "-"
        )
          return "-";
        // Remove any existing % sign and parse
        const num = parseFloat(String(value).replace("%", ""));
        if (isNaN(num)) return "-";
        return num.toFixed(2) + "%";
      }

      function formatNumber(value) {
        if (
          value === null ||
          value === undefined ||
          value === "" ||
          value === "-"
        )
          return "-";
        const num = parseFloat(value);
        if (isNaN(num)) return value; // Return original if not a number
        return num.toFixed(2);
      }

      // Data structure mapping functions
      function mapTotalAssetsData(data) {
        if (!data) return null;

        // If fuelTypeData and riskTypeData are already provided (from backend transformation), use them
        if (data.fuelTypeData && data.riskTypeData) {
          return {
            fuelTypeData: data.fuelTypeData,
            riskTypeData: data.riskTypeData,
            total: data.total || data.summary?.value || 0,
          };
        }

        // Otherwise, transform from API response format
        if (!data.chart || !data.chart.data) return null;

        const fuelTypeData = { labels: [], values: [], colors: [] };
        const riskTypeData = {
          labels: [],
          values: [],
          colors: [],
          valuesCurrency: [],
        };

        // Check if data is in API format (fuel types with breakdown) or transformed format (risk levels with categories)
        const firstItem = data.chart.data[0];
        const isApiFormat =
          firstItem &&
          firstItem.breakdown &&
          Array.isArray(firstItem.breakdown);

        if (isApiFormat) {
          // API format: fuel types with breakdown array
          const fuelMap = new Map();
          const riskMap = new Map();

          data.chart.data.forEach((fuelType) => {
            const fuelTypeLabel =
              fuelType.type === "ev"
                ? "EV"
                : fuelType.type === "ice"
                ? "ICE"
                : fuelType.type === "hybrid"
                ? "Hybrid"
                : fuelType.type === "mixed"
                ? "Mixed Fuel"
                : "Mixed";
            const fuelTypeColor =
              fuelType.type === "ev"
                ? "ev"
                : fuelType.type === "ice"
                ? "ice"
                : fuelType.type === "hybrid"
                ? "hb"
                : fuelType.type === "mixed"
                ? "mxft"
                : "mxft";

            // Aggregate fuel type totals
            const totalForFuelType = fuelType.value || 0;
            if (!fuelMap.has(fuelTypeLabel)) {
              fuelMap.set(fuelTypeLabel, { value: 0, color: fuelTypeColor });
            }
            fuelMap.get(fuelTypeLabel).value += totalForFuelType;

            // Process breakdown by risk level
            if (fuelType.breakdown && Array.isArray(fuelType.breakdown)) {
              fuelType.breakdown.forEach((riskBand) => {
                const riskLabel = riskBand.label; // 'Low', 'Medium', or 'High'
                const count = riskBand.count || 0;
                const value = riskBand.value || 0; // Money value for borrowers, percentage/count for assets

                // Aggregate risk type totals
                if (!riskMap.has(riskLabel)) {
                  riskMap.set(riskLabel, {
                    count: 0,
                    value: 0,
                    color:
                      riskLabel === "High"
                        ? "#dc2626"
                        : riskLabel === "Medium"
                        ? "#f59e0b"
                        : "#10b981",
                  });
                }
                riskMap.get(riskLabel).count += count;
                // For borrowers, value is money; for assets, we'll use count * 100000 as placeholder
                if (riskBand.identifier === "money") {
                  riskMap.get(riskLabel).value += value;
                } else {
                  riskMap.get(riskLabel).value += count * 100000; // Placeholder for assets
                }
              });
            }
          });

          // Build fuelTypeData arrays
          fuelMap.forEach((data, label) => {
            fuelTypeData.labels.push(label);
            fuelTypeData.values.push(data.value);
            fuelTypeData.colors.push(getFuelColor(data.color));
          });

          // Build riskTypeData arrays
          riskMap.forEach((data, label) => {
            riskTypeData.labels.push(label);
            riskTypeData.values.push(data.count);
            riskTypeData.colors.push(data.color);
            riskTypeData.valuesCurrency.push(formatCurrency(data.value));
          });
        } else {
          // Transformed format: risk levels with categories
          const fuelMap = new Map();
          data.chart.data.forEach((riskLevel) => {
            if (riskLevel.categories && Array.isArray(riskLevel.categories)) {
              riskLevel.categories.forEach((category) => {
                const fuelType = category.label;
                if (!fuelMap.has(fuelType)) {
                  fuelMap.set(fuelType, { value: 0, color: category.color });
                }
                fuelMap.get(fuelType).value += category.value;
              });
            }
          });

          fuelMap.forEach((data, label) => {
            fuelTypeData.labels.push(label);
            fuelTypeData.values.push(data.value);
            fuelTypeData.colors.push(getFuelColor(data.color));
          });

          // Process risk type breakdown
          const riskMap = new Map();
          data.chart.data.forEach((riskLevel) => {
            const risk = riskLevel.label;
            const total = riskLevel.categories
              ? riskLevel.categories.reduce((sum, cat) => sum + cat.value, 0)
              : 0;
            if (total > 0) {
              riskMap.set(risk, { value: total, color: riskLevel.color });
            }
          });

          riskMap.forEach((data, label) => {
            riskTypeData.labels.push(label);
            riskTypeData.values.push(data.value);
            riskTypeData.colors.push(getRiskColor(label));
            riskTypeData.valuesCurrency.push(
              formatCurrency(data.value * 100000)
            ); // Placeholder
          });
        }

        return {
          fuelTypeData,
          riskTypeData,
          total: data.total || data.summary?.value || 0,
        };
      }

      function getFuelColor(colorCode) {
        const colorMap = {
          ev: "#28A745",
          ice: "#002C84",
          hybrid: "#E4572E",
          hb: "#E4572E",
          mxft: "#8B4513",
        };
        return colorMap[colorCode?.toLowerCase()] || "#cccccc";
      }

      function getRiskColor(riskLevel) {
        const risk = riskLevel?.toLowerCase() || "";
        if (risk.includes("high")) return "#dc2626";
        if (risk.includes("medium")) return "#f59e0b";
        return "#10b981";
      }

      function mapPortfolioValueData(data) {
        if (!data) return null;

        const borrowerData = {
          labels: [],
          values: [],
          colors: [],
          valuesCurrency: [],
        };
        const assetData = {
          labels: [],
          values: [],
          colors: [],
          valuesCurrency: [],
        };

        // Process borrower breakdown
        if (data.Borrower && data.Borrower.seriesOptions) {
          data.Borrower.seriesOptions.forEach((option) => {
            borrowerData.labels.push(option.label);
            borrowerData.values.push(option.value || 0);
            borrowerData.colors.push(getFuelColor(option.icon || option.label));
            borrowerData.valuesCurrency.push(option.valueDescription || "-");
          });
        }

        // Process asset breakdown
        if (data.Asset && data.Asset.seriesOptions) {
          data.Asset.seriesOptions.forEach((option) => {
            assetData.labels.push(option.label);
            assetData.values.push(option.value || 0);
            assetData.colors.push(getFuelColor(option.icon || option.label));
            assetData.valuesCurrency.push(option.valueDescription || "-");
          });
        }

        return {
          borrowerData,
          assetData,
          totalValue: data.totalValue || 0,
        };
      }

      function mapRiskData(data, tabKey) {
        if (!data || !data[tabKey]) return [];
        return data[tabKey];
      }

      // Logo path - default value (can be overridden by data)
      window.logoPath =
        window.logoPath ||
        "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg";

      // Page rendering functions
      function renderCoverPage(date) {
        const logo =
          window.logoPath ||
          "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg";
        return `
                <div class="page cover-page">
                    <div style="position: absolute; top: 20mm; left: 20mm;">
                        <div class="logo" style="text-align: left;">
                            <img src="${logo}" alt="TAPFIN" style="height: 60px; width: auto;">
                        </div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding-top: 100px;">
                        <div class="cover-title" style="margin-bottom: 20px; line-height: 1.2;">
                            <div style="font-size: 72px; font-weight: bold; font-style: italic; color: #2563eb; margin-bottom: 10px;">TRUST</div>
                            <div style="font-size: 72px; font-weight: bold; font-style: italic; color: #1e40af;">REPORT</div>
                        </div>
                        <div class="cover-date" style="margin-top: 30px; font-size: 24px; color: #10b981; font-weight: bold;">${
                          date ||
                          new Date()
                            .toLocaleDateString("en-GB", {
                              day: "2-digit",
                              month: "short",
                              year: "numeric",
                            })
                            .toUpperCase()
                        }</div>
                    </div>
                    <div class="geometric-shapes" style="position: absolute; bottom: 50mm; left: 0; right: 0; height: 300px;">
                        <div class="shape shape-blue" style="width: 80px; height: 80px; transform: rotate(45deg); left: 10%; bottom: 20%;"></div>
                        <div class="shape shape-green" style="width: 60px; height: 60px; transform: rotate(30deg); left: 20%; bottom: 30%;"></div>
                        <div class="shape shape-blue" style="width: 100px; height: 100px; transform: rotate(-45deg); right: 15%; bottom: 25%;"></div>
                        <div class="shape shape-green" style="width: 70px; height: 70px; transform: rotate(60deg); right: 25%; bottom: 35%;"></div>
                        <div class="shape shape-gray" style="width: 50px; height: 50px; left: 15%; bottom: 40%;"></div>
                        <div class="shape shape-gray" style="width: 40px; height: 40px; right: 20%; bottom: 45%;"></div>
                        <div class="shape shape-blue" style="width: 90px; height: 90px; transform: rotate(15deg); left: 30%; bottom: 15%;"></div>
                        <div class="shape shape-green" style="width: 55px; height: 55px; transform: rotate(-30deg); right: 30%; bottom: 20%;"></div>
                    </div>
                    <div class="page-footer">
                        <div></div>
                        <div></div>
                        <div class="page-number">1</div>
                    </div>
                </div>
            `;
      }

      function renderTableOfContents() {
        const tocItems = [
          { no: 1, title: "Total Asset Monitored", page: 1 },
          { no: 2, title: "Total Borrowers", page: 1 },
          { no: 3, title: "Portfolio Value", page: 2 },
          { no: 4, title: "Borrower Risk Analysis", page: 2 },
          { no: 5, title: "Borrower Detailed Breakdown", page: 3 },
          { no: 6, title: "OEM Risk Analysis", page: 4 },
          { no: 7, title: "OEM Detailed Breakdown", page: 4 },
          { no: 8, title: "Asset Risk Analysis", page: 5 },
          { no: 9, title: "Asset Detailed Breakdown", page: 5 },
          { no: 10, title: "Fuel Risk Analysis", page: 6 },
          { no: 11, title: "Fuel Detailed Breakdown", page: 7 },
          { no: 12, title: "Region Risk Analysis", page: 8 },
          { no: 13, title: "Region Detailed Breakdown", page: 9 },
          { no: 14, title: "Risk Trend Analysis", page: "10-11" },
        ];

        let tocRows = "";
        tocItems.forEach((item) => {
          tocRows += `
                    <tr>
                        <td>${item.no}</td>
                        <td>${item.title}</td>
                        <td>${item.page}</td>
                    </tr>
                `;
        });

        return `
                <div class="page">
                    <div class="report-header">
                        <div class="report-title">TRUST Report</div>
                        <div class="logo">
                            <img src="${
                              window.logoPath ||
                              "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                            }" alt="TAPFIN">
                        </div>
                    </div>
                    <div class="toc-title">Table of Content</div>
                    <table class="toc-table">
                        <thead>
                            <tr>
                                <th>S. No</th>
                                <th>Title</th>
                                <th>Page No.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tocRows}
                        </tbody>
                    </table>
                    <div class="page-footer">
                        <div></div>
                        <div></div>
                        <div class="page-number">2</div>
                    </div>
                </div>
            `;
      }

      function renderAssetsBorrowersPage(
        totalAssetsData,
        totalBorrowersData,
        generatedDate
      ) {
        const assetsFuelChart = totalAssetsData?.fuelTypeData
          ? createPieChart(
              totalAssetsData.fuelTypeData.values,
              totalAssetsData.fuelTypeData.colors,
              180
            )
          : "";
        const assetsRiskChart = totalAssetsData?.riskTypeData
          ? createPieChart(
              totalAssetsData.riskTypeData.values,
              totalAssetsData.riskTypeData.colors,
              180
            )
          : "";
        const borrowersFuelChart = totalBorrowersData?.fuelTypeData
          ? createPieChart(
              totalBorrowersData.fuelTypeData.values,
              totalBorrowersData.fuelTypeData.colors,
              180
            )
          : "";
        const borrowersRiskChart = totalBorrowersData?.riskTypeData
          ? createPieChart(
              totalBorrowersData.riskTypeData.values,
              totalBorrowersData.riskTypeData.colors,
              180
            )
          : "";

        let assetsFuelTable = "";
        if (totalAssetsData?.fuelTypeData) {
          const total = totalAssetsData.fuelTypeData.values.reduce(
            (a, b) => a + b,
            0
          );
          totalAssetsData.fuelTypeData.labels.forEach((label, i) => {
            const value = totalAssetsData.fuelTypeData.values[i];
            const percentage =
              total > 0 ? ((value / total) * 100).toFixed(2) : 0;
            assetsFuelTable += `
                        <tr>
                            <td><span class="color-dot" style="background: ${totalAssetsData.fuelTypeData.colors[i]}"></span>${label}</td>
                            <td>${value}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
          });
        }

        let assetsRiskTable = "";
        if (totalAssetsData?.riskTypeData) {
          const total = totalAssetsData.riskTypeData.values.reduce(
            (a, b) => a + b,
            0
          );
          totalAssetsData.riskTypeData.labels.forEach((label, i) => {
            const value = totalAssetsData.riskTypeData.values[i];
            const percentage =
              total > 0 ? ((value / total) * 100).toFixed(2) : 0;
            const currencyValue =
              totalAssetsData.riskTypeData.valuesCurrency?.[i] ||
              formatCurrency(value * 100000);
            assetsRiskTable += `
                        <tr>
                            <td><span class="color-dot" style="background: ${totalAssetsData.riskTypeData.colors[i]}"></span>${label}</td>
                            <td>${value}</td>
                            <!--<td>${currencyValue}</td>-->
                            <td>${percentage}%</td>
                        </tr>
                    `;
          });
        }

        let borrowersFuelTable = "";
        if (totalBorrowersData?.fuelTypeData) {
          const total = totalBorrowersData.fuelTypeData.values.reduce(
            (a, b) => a + b,
            0
          );
          totalBorrowersData.fuelTypeData.labels.forEach((label, i) => {
            const value = totalBorrowersData.fuelTypeData.values[i];
            const percentage =
              total > 0 ? ((value / total) * 100).toFixed(2) : 0;
            borrowersFuelTable += `
                        <tr>
                            <td><span class="color-dot" style="background: ${totalBorrowersData.fuelTypeData.colors[i]}"></span>${label}</td>
                            <td>${value}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
          });
        }

        let borrowersRiskTable = "";
        if (totalBorrowersData?.riskTypeData) {
          const total = totalBorrowersData.riskTypeData.values.reduce(
            (a, b) => a + b,
            0
          );
          totalBorrowersData.riskTypeData.labels.forEach((label, i) => {
            const value = totalBorrowersData.riskTypeData.values[i];
            const percentage =
              total > 0 ? ((value / total) * 100).toFixed(2) : 0;
            const currencyValue =
              totalBorrowersData.riskTypeData.valuesCurrency?.[i] ||
              formatCurrency(value * 100000);
            borrowersRiskTable += `
                        <tr>
                            <td><span class="color-dot" style="background: ${totalBorrowersData.riskTypeData.colors[i]}"></span>${label}</td>
                            <td>${value}</td>
                            <td>${currencyValue}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
          });
        }

        return `
                <div class="page">
                    <div class="report-header">
                        <div class="report-title">TRUST Report</div>
                        <div class="logo">
                            <img src="${
                              window.logoPath ||
                              "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                            }" alt="TAPFIN">
                        </div>
                    </div>
                    
                    <div class="section-title">
                        <span>Total Assets Monitored</span>
                        <span class="section-total">${
                          totalAssetsData?.total || 0
                        }</span>
                    </div>
                    
                    <div class="two-column">
                        <div>
                            <div class="chart-title">Breakdown by Fuel Type (Assets)</div>
                            <div class="chart-wrapper">
                                ${assetsFuelChart}
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fuel Type</th>
                                        <th>No of Assets</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assetsFuelTable}
                                </tbody>
                            </table>
                        </div>
                        
                        <div>
                            <div class="chart-title">Breakdown by Risk Type (Assets)</div>
                            <div class="chart-wrapper">
                                ${assetsRiskChart}
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Risk Type</th>
                                        <th>No of Assets</th>
                                        <!--<th>Value</th>-->
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assetsRiskTable}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="section-title" style="margin-top: 40px;">
                        <span>Total Borrowers</span>
                        <span class="section-total">${
                          totalBorrowersData?.total || 0
                        }</span>
                    </div>
                    
                    <div class="two-column">
                        <div>
                            <div class="chart-title">Breakdown by Fuel Type (Borrowers)</div>
                            <div class="chart-wrapper">
                                ${borrowersFuelChart}
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fuel Type</th>
                                        <th>No. of Borrowers</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${borrowersFuelTable}
                                </tbody>
                            </table>
                        </div>
                        
                        <div>
                            <div class="chart-title">Breakdown by Risk Type (Borrowers)</div>
                            <div class="chart-wrapper">
                                ${borrowersRiskChart}
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Risk Type</th>
                                        <th>No. of Borrowers</th>
                                        <th>Value</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${borrowersRiskTable}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="page-footer">
                        <div>Generated on ${
                          generatedDate ||
                          new Date().toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric",
                          })
                        }</div>
                        <div style="text-align: center;">This is an electronically generated report.</div>
                        <div class="page-number">1</div>
                    </div>
                </div>
            `;
      }

      function renderPortfolioValuePage(
        portfolioValueData,
        borrowerRiskData,
        generatedDate
      ) {
        // Create two separate pie charts - one for borrower, one for asset (matching Total Borrowers module structure)
        const borrowerChart = portfolioValueData?.borrowerData
          ? createPieChart(
              portfolioValueData.borrowerData.values,
              portfolioValueData.borrowerData.colors,
              180
            )
          : "";
        const assetChart = portfolioValueData?.assetData
          ? createPieChart(
              portfolioValueData.assetData.values,
              portfolioValueData.assetData.colors,
              180
            )
          : "";

        let borrowerTable = "";
        if (
          portfolioValueData?.borrowerData &&
          portfolioValueData.borrowerData.labels.length > 0
        ) {
          portfolioValueData.borrowerData.labels.forEach((label, i) => {
            const value =
              portfolioValueData.borrowerData.valuesCurrency &&
              portfolioValueData.borrowerData.valuesCurrency[i]
                ? portfolioValueData.borrowerData.valuesCurrency[i]
                : "-";
            // Use percentage directly from API (no rounding/fixing)
            const percentage =
              portfolioValueData.borrowerData.values &&
              portfolioValueData.borrowerData.values[i]
                ? portfolioValueData.borrowerData.values[i]
                : 0;
            borrowerTable += `
                        <tr>
                            <td><span class="color-dot" style="background: ${
                              portfolioValueData.borrowerData.colors[i] ||
                              "#cccccc"
                            }"></span>${label}</td>
                            <td>${value}</td>
                            <td>${percentage.toFixed(2)}%</td>
                        </tr>
                    `;
          });
        } else {
          borrowerTable =
            '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6b7280;">No data available</td></tr>';
        }

        let assetTable = "";
        if (
          portfolioValueData?.assetData &&
          portfolioValueData.assetData.labels.length > 0
        ) {
          portfolioValueData.assetData.labels.forEach((label, i) => {
            const value =
              portfolioValueData.assetData.valuesCurrency &&
              portfolioValueData.assetData.valuesCurrency[i]
                ? portfolioValueData.assetData.valuesCurrency[i]
                : "-";

            const percentage =
              portfolioValueData.assetData.values &&
              portfolioValueData.assetData.values[i]
                ? portfolioValueData.assetData.values[i]
                : 0;
            assetTable += `
                        <tr>
                            <td><span class="color-dot" style="background: ${
                              portfolioValueData.assetData.colors[i] ||
                              "#cccccc"
                            }"></span>${label}</td>
                            <td>${value}</td>
                            <td>${percentage.toFixed(2)}%</td>
                        </tr>
                    `;
          });
        } else {
          assetTable =
            '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6b7280;">No data available</td></tr>';
        }

        let riskTable = "";
        if (borrowerRiskData && borrowerRiskData.length > 0) {
          borrowerRiskData.forEach((row) => {
            const riskClass = row.risk?.toLowerCase() || "";
            riskTable += `
                        <tr>
                            <td class="${
                              riskClass.includes("high")
                                ? "risk-high"
                                : riskClass.includes("medium")
                                ? "risk-medium"
                                : "risk-low"
                            }">${row.risk || row.firstColumn || "-"}</td>
                            <td>${
                              row.borrowers || row["No. of Borrower"] || 0
                            }</td>
                            <td>${row.assets || row["No. of Assets"] || 0}</td>
                            <td>${formatCurrency(
                              row.aum || row["Loan (AUM)"] || 0
                            )}</td>
                            <td>${formatPercentage(
                              row.operational?.stress || row["Stress %"] || "-"
                            )}</td>
                            <td>${formatCurrency(
                              row.operational?.residualValue ||
                                row["Residual Value"] ||
                                0
                            )}</td>
                            <td>${formatCurrency(
                              row.operational?.expectedCreditLoss ||
                                row["ECL (₹)"] ||
                                0
                            )}</td>
                            <td>${formatCurrency(
                              row.financial?.sanctionAmount ||
                                row["Sanction Amount"] ||
                                0
                            )}</td>
                            <td>${formatPercentage(
                              row.financial?.pd || row["PD"] || "-"
                            )}</td>
                            <td>${formatPercentage(
                              row.financial?.lgd || row["LGD"] || "-"
                            )}</td>
                            <td>${formatCurrency(
                              row.financial?.expectedCreditLossRs ||
                                row["ECL (₹)"] ||
                                0
                            )}</td>
                        </tr>
                    `;
          });
        }

        return `
                <div class="page">
                    <div class="report-header">
                        <div class="report-title">TRUST Report</div>
                        <div class="logo">
                            <img src="${
                              window.logoPath ||
                              "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                            }" alt="TAPFIN">
                        </div>
                    </div>
                    
                    <div class="section-title">
                        <span>Portfolio Value</span>
                        <span class="section-total">${
                          portfolioValueData?.totalValue
                            ? formatCurrency(portfolioValueData.totalValue)
                            : "₹0"
                        }</span>
                    </div>
                    
                    <div class="portfolio-section">
                        <div>
                            <div class="chart-title">Breakdown by Borrower wise</div>
                            <div class="chart-wrapper">
                                ${borrowerChart}
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fuel Type</th>
                                        <th>Value</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${borrowerTable}
                                </tbody>
                            </table>
                        </div>
                        
                        <div>
                            <div class="chart-title">Breakdown by Asset wise</div>
                            <div class="chart-wrapper">
                                ${assetChart}
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fuel Type</th>
                                        <th>Value</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assetTable}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="section-title" style="margin-top: 30px;">
                        <span>Borrower Risk Analysis</span>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Risk</th>
                                <th colspan="3" class="sub-header">Borrower Information</th>
                                <th colspan="3" class="sub-header">Operational Risk</th>
                                <th colspan="4" class="sub-header">Financial Risk & Exposure</th>
                            </tr>
                            <tr>
                                <th class="sub-header">No. of Borrower</th>
                                <th class="sub-header">No. of Assets</th>
                                <th class="sub-header">Loan (AUM)</th>
                                <th class="sub-header">Stress %</th>
                                <th class="sub-header">Residual Value</th>
                                <th class="sub-header">ECL (₹)</th>
                                <th class="sub-header">Sanction Amount</th>
                                <th class="sub-header">PD</th>
                                <th class="sub-header">LGD</th>
                                <th class="sub-header">ECL (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${riskTable}
                        </tbody>
                    </table>
                    
                    <div class="page-footer">
                        <div>Generated on ${
                          generatedDate ||
                          new Date().toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric",
                          })
                        }</div>
                        <div style="text-align: center;">This is an electronically generated report.</div>
                        <div class="page-number">2</div>
                    </div>
                </div>
            `;
      }

      function renderDetailedBreakdownPage(
        riskData,
        riskLevel,
        pageNumber,
        generatedDate
      ) {
        const filteredData = riskData.filter((row) => {
          const risk = (row.risk || row.firstColumn || "").toLowerCase();
          return risk.includes(riskLevel.toLowerCase());
        });

        let tableRows = "";
        filteredData.forEach((row, index) => {
          tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${
                          row.name ||
                          row.borrowerName ||
                          row["Borrower Name"] ||
                          "-"
                        }</td>
                        <td>${row.assets || row["No. of Assets"] || 0}</td>
                        <td>${formatCurrency(
                          row.aum || row["Loan (AUM)"] || 0
                        )}</td>
                        <td>${formatPercentage(
                          row.operational?.stress || row["Stress %"] || "-"
                        )}</td>
                        <td>${formatCurrency(
                          row.operational?.residualValue ||
                            row["Residual Value"] ||
                            0
                        )}</td>
                        <td>${formatCurrency(
                          row.operational?.expectedCreditLoss ||
                            row["ECL (₹)"] ||
                            0
                        )}</td>
                        <td>${formatPercentage(
                          row.financial?.pd || row["PD"] || "-"
                        )}</td>
                        <td>${formatPercentage(
                          row.financial?.lgd || row["LGD"] || "-"
                        )}</td>
                        <td>${formatCurrency(
                          row.financial?.expectedCreditLossRs ||
                            row["ECL (₹)"] ||
                            0
                        )}</td>
                    </tr>
                `;
        });

        const riskClass = riskLevel.toLowerCase();
        const riskColor = riskClass.includes("high")
          ? "high"
          : riskClass.includes("medium")
          ? "medium"
          : "low";

        return `
                <div class="page">
                    <div class="report-header">
                        <div class="report-title">TRUST Report</div>
                        <div class="logo">
                            <img src="${
                              window.logoPath ||
                              "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                            }" alt="TAPFIN">
                        </div>
                    </div>
                    
                    <div class="section-title">Detailed Breakdown</div>
                    
                    <div class="risk-section">
                        <div class="risk-header ${riskColor}">
                            Risk: ${riskLevel} • Count: ${filteredData.length}
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">S. No</th>
                                    <th rowspan="2">Borrower Name</th>
                                    <th rowspan="2">No. of Assets</th>
                                    <th rowspan="2">Loan (AUM)</th>
                                    <th colspan="3" class="sub-header">Operational Risk</th>
                                    <th colspan="3" class="sub-header">Financial Risk & Exposure</th>
                                </tr>
                                <tr>
                                    <th class="sub-header">Stress %</th>
                                    <th class="sub-header">Residual Value</th>
                                    <th class="sub-header">ECL (₹)</th>
                                    <th class="sub-header">PD</th>
                                    <th class="sub-header">LGD</th>
                                    <th class="sub-header">ECL (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="page-footer">
                        <div>Generated on ${
                          generatedDate ||
                          new Date().toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric",
                          })
                        }</div>
                        <div style="text-align: center;">This is an electronically generated report.</div>
                        <div class="page-number">${pageNumber}</div>
                    </div>
                </div>
            `;
      }

      function renderCategoryRiskPage(
        categoryData,
        categoryName,
        pageNumber,
        generatedDate
      ) {
        let summaryTable = "";
        if (categoryData && categoryData.length > 0) {
          categoryData.forEach((row) => {
            summaryTable += `
                        <tr>
                            <td>${
                              row.firstColumn || row[categoryName] || "-"
                            }</td>
                            <td>${
                              row.borrowers || row["No. of Borrower"] || 0
                            }</td>
                            <td>${row.assets || row["No. of Assets"] || 0}</td>
                            <td>${formatCurrency(
                              row.aum || row["Loan (AUM)"] || 0
                            )}</td>
                            <td>${formatPercentage(
                              row.operational?.stress || row["Stress %"] || "-"
                            )}</td>
                            <td>${formatCurrency(
                              row.operational?.residualValue ||
                                row["Residual Value"] ||
                                0
                            )}</td>
                            <td>${formatCurrency(
                              row.operational?.expectedCreditLoss ||
                                row["ECL (₹)"] ||
                                0
                            )}</td>
                            <td>${formatCurrency(
                              row.financial?.sanctionAmount ||
                                row["Sanction Amount"] ||
                                0
                            )}</td>
                            <td>${formatPercentage(
                              row.financial?.pd || row["PD"] || "-"
                            )}</td>
                            <td>${formatPercentage(
                              row.financial?.lgd || row["LGD"] || "-"
                            )}</td>
                            <td>${formatCurrency(
                              row.financial?.expectedCreditLossRs ||
                                row["ECL (₹)"] ||
                                0
                            )}</td>
                        </tr>
                    `;
          });
        }

        return `
                <div class="page">
                    <div class="report-header">
                        <div class="report-title">TRUST Report</div>
                        <div class="logo">
                            <img src="${
                              window.logoPath ||
                              "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                            }" alt="TAPFIN">
                        </div>
                    </div>
                    
                    <div class="section-title">${categoryName} Risk Analysis</div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2">${categoryName}</th>
                                <th rowspan="2">No. of Borrower</th>
                                <th rowspan="2">Assets</th>
                                <th rowspan="2">Loan (AUM)</th>
                                <th colspan="3" class="sub-header">Operational Risk</th>
                                <th colspan="4" class="sub-header">Financial Risk & Exposure</th>
                            </tr>
                            <tr>
                                <th class="sub-header">Stress %</th>
                                <th class="sub-header">Residual Value</th>
                                <th class="sub-header">ECL (₹)</th>
                                <th class="sub-header">Sanction Amount</th>
                                <th class="sub-header">PD</th>
                                <th class="sub-header">LGD</th>
                                <th class="sub-header">ECL (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summaryTable}
                        </tbody>
                    </table>
                    
                    <div class="page-footer">
                        <div>Generated on ${
                          generatedDate ||
                          new Date().toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric",
                          })
                        }</div>
                        <div style="text-align: center;">This is an electronically generated report.</div>
                        <div class="page-number">${pageNumber}</div>
                    </div>
                </div>
            `;
      }

      function renderCategoryDetailedBreakdown(
        categoryData,
        categoryName,
        categoryValue,
        pageNumber,
        generatedDate
      ) {
        const filteredData = categoryData.filter((row) => {
          const value = row.firstColumn || row[categoryName] || "";
          return value === categoryValue;
        });

        let tableRows = "";
        filteredData.forEach((row, index) => {
          tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${
                          row.name ||
                          row.borrowerName ||
                          row["Borrower Name"] ||
                          "-"
                        }</td>
                        <td>${row.assets || row["No. of Assets"] || 0}</td>
                        <td>${formatCurrency(
                          row.aum || row["Loan (AUM)"] || 0
                        )}</td>
                        <td>${formatPercentage(
                          row.operational?.stress || row["Stress %"] || "-"
                        )}</td>
                        <td>${formatCurrency(
                          row.operational?.residualValue ||
                            row["Residual Value"] ||
                            0
                        )}</td>
                        <td>${formatCurrency(
                          row.operational?.expectedCreditLoss ||
                            row["ECL (₹)"] ||
                            0
                        )}</td>
                        <td>${formatPercentage(
                          row.financial?.pd || row["PD"] || "-"
                        )}</td>
                        <td>${formatPercentage(
                          row.financial?.lgd || row["LGD"] || "-"
                        )}</td>
                        <td>${formatCurrency(
                          row.financial?.expectedCreditLossRs ||
                            row["ECL (₹)"] ||
                            0
                        )}</td>
                    </tr>
                `;
        });

        return `
                <div class="page">
                    <div class="report-header">
                        <div class="report-title">TRUST Report</div>
                        <div class="logo">
                            <img src="${
                              window.logoPath ||
                              "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                            }" alt="TAPFIN">
                        </div>
                    </div>
                    
                    <div class="section-title">Detailed Breakdown</div>
                    
                    <div class="risk-section">
                        <div class="risk-header">
                            ${categoryName}: ${categoryValue} • Count: ${
          filteredData.length
        }
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">S. No</th>
                                    <th rowspan="2">Borrower Name</th>
                                    <th rowspan="2">No. of Assets</th>
                                    <th rowspan="2">Loan (AUM)</th>
                                    <th colspan="3" class="sub-header">Operational Risk</th>
                                    <th colspan="3" class="sub-header">Financial Risk & Exposure</th>
                                </tr>
                                <tr>
                                    <th class="sub-header">Stress %</th>
                                    <th class="sub-header">Residual Value</th>
                                    <th class="sub-header">ECL (₹)</th>
                                    <th class="sub-header">PD</th>
                                    <th class="sub-header">LGD</th>
                                    <th class="sub-header">ECL (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="page-footer">
                        <div>Generated on ${
                          generatedDate ||
                          new Date().toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric",
                          })
                        }</div>
                        <div style="text-align: center;">This is an electronically generated report.</div>
                        <div class="page-number">${pageNumber}</div>
                    </div>
                </div>
            `;
      }

      function renderRiskTrendPage(trendData, pageNumber, generatedDate) {
        let pages = "";

        if (trendData && Object.keys(trendData).length > 0) {
          const trendKeys = Object.keys(trendData);

          // Render main section title on first page
          let currentPage = pageNumber;

          trendKeys.forEach((key, index) => {
            const data = trendData[key];
            const chartData = {
              labels: data.x || [],
              series: data.series || [],
            };

            if (
              !chartData.labels ||
              chartData.labels.length === 0 ||
              !chartData.series ||
              chartData.series.length === 0
            ) {
              return; // Skip if no data
            }

            const colors = chartData.series.map((s) => s.color || "#dc2626");
            const lineChart = createLineChart(chartData, colors, 600, 300);

            let tableRows = "";
            if (chartData.labels && chartData.labels.length > 0) {
              chartData.labels.forEach((label, i) => {
                tableRows += `
                                <tr>
                                    <td>${label}</td>
                                    ${chartData.series
                                      .map((s) => `<td>${s.data[i] || 0}</td>`)
                                      .join("")}
                                </tr>
                            `;
              });
            }

            // Table headers: High, Medium, Low (matching PRD template)
            const tableHeaders = chartData.series
              .map((s) => {
                const shortName = s.name.includes("High")
                  ? "High"
                  : s.name.includes("Medium")
                  ? "Medium"
                  : "Low";
                return `<th>${shortName}</th>`;
              })
              .join("");

            // Add main section title only on first trend
            const showMainTitle = index === 0;

            pages += `
                        <div class="page">
                            <div class="report-header">
                                <div class="report-title">TRUST Report</div>
                                <div class="logo">
                                    <img src="${
                                      window.logoPath ||
                                      "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg"
                                    }" alt="TAPFIN">
                                </div>
                            </div>
                            
                            ${
                              showMainTitle
                                ? '<div class="section-title"><span>Risk Trend Analysis</span></div>'
                                : ""
                            }
                            <div class="section-title" style="margin-top: ${
                              showMainTitle ? "10px" : "0"
                            };">
                                <span>${key}</span>
                            </div>
                            
                            <div class="line-chart-container" style="margin-top: 20px;">
                                <div class="line-chart-wrapper">
                                    ${lineChart}
                                </div>
                                <div class="chart-legend" style="margin-top: 15px; margin-bottom: 20px;">
                                    ${chartData.series
                                      .map(
                                        (s, i) => `
                                        <div class="legend-item">
                                            <span class="legend-dot" style="background: ${
                                              s.color || colors[i]
                                            }"></span>
                                            <span>${s.name}</span>
                                        </div>
                                    `
                                      )
                                      .join("")}
                                </div>
                                
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Date Range</th>
                                            ${chartData.series
                                              .map((s) => {
                                                // Extract short name: "High Risk" -> "High", "Medium Risk" -> "Medium", "Low Risk" -> "Low"
                                                let shortName = "High";
                                                if (s.name.includes("Medium"))
                                                  shortName = "Medium";
                                                else if (s.name.includes("Low"))
                                                  shortName = "Low";
                                                return `<th>${shortName}</th>`;
                                              })
                                              .join("")}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="page-footer">
                                <div>Generated on ${
                                  generatedDate ||
                                  new Date().toLocaleDateString("en-GB", {
                                    day: "2-digit",
                                    month: "short",
                                    year: "numeric",
                                  })
                                }</div>
                                <div style="text-align: center;">This is an electronically generated report.</div>
                                <div class="page-number">${
                                  currentPage + index
                                }</div>
                            </div>
                        </div>
                    `;
          });
        }

        return pages;
      }

      // Main function to generate the complete report
      function generateReport(data) {
        const container = document.getElementById("report-container");
        if (!container) return;

        // Use logo path from data if provided, otherwise use default
        if (data && data.logoPath) {
          window.logoPath = data.logoPath;
        } else if (!window.logoPath) {
          window.logoPath =
            "https://cdn.tapfin.in/wp-content/uploads/tapfin.v1.svg";
        }

        const generatedDate =
          data.generatedDate ||
          new Date().toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric",
          });
        const reportDate =
          data.reportDate ||
          new Date()
            .toLocaleDateString("en-GB", {
              day: "2-digit",
              month: "short",
              year: "numeric",
            })
            .toUpperCase();

        let html = "";

        // Cover Page
        html += renderCoverPage(reportDate);

        // Table of Contents
        html += renderTableOfContents();

        // Page 1: Total Assets & Borrowers
        const totalAssetsData = mapTotalAssetsData(
          data.lenderData?.totalAssets
        );
        const totalBorrowersData = mapTotalAssetsData(
          data.lenderData?.totalBorrowers
        );
        html += renderAssetsBorrowersPage(
          totalAssetsData,
          totalBorrowersData,
          generatedDate
        );

        // Page 2: Portfolio Value & Borrower Risk Analysis
        const portfolioValueData = mapPortfolioValueData(
          data.lenderData?.portfolioValue
        );
        const borrowerRiskData = mapRiskData(data.riskData, "borrower");
        html += renderPortfolioValuePage(
          portfolioValueData,
          borrowerRiskData,
          generatedDate
        );

        // Page 3: Detailed Breakdown by Risk
        if (borrowerRiskData && borrowerRiskData.length > 0) {
          const riskLevels = ["High", "Medium", "Low"];
          riskLevels.forEach((risk, index) => {
            html += renderDetailedBreakdownPage(
              borrowerRiskData,
              risk,
              3 + index,
              generatedDate
            );
          });
        }

        // Pages 4-9: Category Risk Analysis (OEM, Asset, Fuel, Region)
        const categories = [
          { key: "oem", name: "OEM Type", pageStart: 6 },
          { key: "assetType", name: "Asset Type", pageStart: 7 },
          { key: "fuel", name: "Fuel Type", pageStart: 8 },
          { key: "region", name: "Region", pageStart: 9 },
        ];

        let currentPage = 6;
        categories.forEach((category) => {
          const categoryData = mapRiskData(data.riskData, category.key);
          if (categoryData && categoryData.length > 0) {
            html += renderCategoryRiskPage(
              categoryData,
              category.name,
              currentPage,
              generatedDate
            );
            currentPage++;

            // Detailed breakdown for each category value
            const uniqueValues = [
              ...new Set(
                categoryData.map((row) => row.firstColumn || row[category.name])
              ),
            ];
            uniqueValues.forEach((value) => {
              html += renderCategoryDetailedBreakdown(
                categoryData,
                category.name,
                value,
                currentPage,
                generatedDate
              );
              currentPage++;
            });
          }
        });

        // Pages 10-11: Risk Trend Analysis
        if (data.riskTrendData) {
          html += renderRiskTrendPage(data.riskTrendData, 10, generatedDate);
        }

        container.innerHTML = html;
      }

      // Initialize report when data is available
      // Example data structure (backend should provide similar structure):
      /*
        const reportData = {
            generatedDate: '09 Oct 2025',
            reportDate: '03 NOV 2025',
            lenderData: {
                totalAssets: { ... },
                totalBorrowers: { ... },
                portfolioValue: { ... }
            },
            riskData: {
                borrower: [ ... ],
                oem: [ ... ],
                assetType: [ ... ],
                fuel: [ ... ],
                region: [ ... ]
            },
            riskTrendData: {
                'Borrower Risk Trend': { ... },
                'EV Risk Trend': { ... }
            }
        };
        generateReport(reportData);
        */

      // Auto-generate if data is provided via window object
      if (window.reportData) {
        generateReport(window.reportData);
      }
    </script>
  </body>
</html>
