<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Panel - Success Planet</title>
    <!--main style-->
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="css/bootstrap.min.css"
    />
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="css/skins/default.css"
      data-name="skins"
    />
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <style>
      :root {
        --bg: #f6f7fb;
        --card: #fff;
        --muted: #6b7280;
        --accent: #f5d76e;
        /* Success Planet Yellow */
        --accent-dark: #f4c430;
        --primary: #2f4e71;
        /* Success Planet Blue */
      }

      body {
        background: var(--bg);
        font-family: "Open Sans", sans-serif;
        min-height: 100vh;
        padding-top: 0;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .card {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(8, 15, 30, 0.06);
        padding: 24px;
        border: 1px solid #e0e0e0;
      }

      .btn-custom {
        background: var(--accent);
        color: #273342;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-custom:hover {
        background: var(--accent-dark);
        transform: translateY(-2px);
      }

      .btn-primary-custom {
        background: var(--primary);
        color: white;
      }

      .btn-primary-custom:hover {
        background: #1a3c5e;
        color: white;
      }

      .btn-danger-custom {
        background: #ff6b6b;
        color: white;
      }

      .btn-danger-custom:hover {
        background: #fa5252;
        color: white;
      }

      .form-control {
        border-radius: 5px;
        padding: 10px;
        border: 1px solid #e0e0e0;
      }

      .form-control:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(245, 215, 110, 0.1);
      }

      .table-custom th {
        background: var(--primary);
        color: white;
        border: none;
      }

      .table-custom td {
        vertical-align: middle;
      }

      .badge-verified {
        background: #4caf50;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8em;
      }

      .badge-pending {
        background: #ff9800;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8em;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .modal-content-custom {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .modal-overlay.active .modal-content-custom {
        transform: scale(1);
      }

      /* Tooltip Styles */
      .action-btn {
        position: relative;
        margin: 0 2px;
      }

      .action-btn:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        margin-bottom: 5px;
        z-index: 10;
        opacity: 0;
        animation: tooltipFade 0.2s forwards;
      }

      @keyframes tooltipFade {
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(-5px);
        }
      }

      /* Success Modal Specifics */
      .success-icon-wrapper {
        width: 80px;
        height: 80px;
        background: #e8f5e9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
      }

      .success-icon-wrapper i {
        font-size: 40px;
        color: #4caf50;
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .login-box {
        max-width: 400px;
        margin: 80px auto;
        border-top: 4px solid var(--accent);
      }

      .nav-header {
        background: var(--primary);
        padding: 15px 0;
        margin-bottom: 30px;
        color: white;
      }

      .nav-header .logo {
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
        text-decoration: none;
      }

      .sidebar {
        background: white;
        border-radius: 12px;
        padding: 20px;
        height: 100%;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid var(--accent);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: var(--primary);
      }

      .stat-label {
        color: var(--muted);
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .dashboard-header .logo {
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
        display: block;
      }

      .user-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
          width: 100%;
        }

        .stat-card {
          margin-bottom: 15px;
        }

        /* Stack the header elements - logo first, controls second */
        .dashboard-header {
          display: block !important;
          text-align: center;
          padding: 15px 15px 20px;
          position: relative;
        }

        .dashboard-header > .logo {
          display: block !important;
          width: 100%;
          text-align: center;
          font-size: 22px !important;
          margin-bottom: 18px !important;
          padding: 8px 0;
          color: var(--accent) !important;
          font-weight: bold;
          position: relative;
          z-index: 2;
        }

        .dashboard-header > .logo span {
          font-size: 0.5em !important;
          display: inline-block;
          vertical-align: middle;
          margin-left: 8px;
          background: var(--accent);
          color: #333;
          padding: 3px 8px;
          border-radius: 4px;
        }

        .dashboard-header > .user-controls {
          display: block !important;
          width: 100%;
          text-align: center;
          margin-top: 0;
          padding: 0 10px;
          position: relative;
          z-index: 1;
        }

        .dashboard-header > .user-controls button {
          display: block !important;
          width: 100%;
          max-width: 280px;
          padding: 12px 20px;
          font-size: 14px;
          margin: 0 auto 12px auto;
        }

        .dashboard-header > .user-controls button:last-child {
          margin-bottom: 0;
        }

        /* Make tables scrollable */
        .table-responsive {
          display: block;
          width: 100%;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        /* Adjust Modal Width */
        .modal-content-custom {
          width: 95%;
          margin: 10px;
          padding: 20px;
        }

        /* Stack Search and Export buttons */
        .card > div:first-child {
          flex-direction: column;
          align-items: stretch !important;
          gap: 10px;
        }

        #searchBox {
          width: 100% !important;
        }

        .btn-primary-custom {
          width: 100%;
        }

        /* Stat cards row fix */
        .row {
          margin-left: -5px;
          margin-right: -5px;
        }

        .row > [class*="col-"] {
          padding-left: 5px;
          padding-right: 5px;
        }

        /* Card padding fix */
        .card {
          padding: 15px;
        }

        /* User Management header fix */
        .card h3 {
          font-size: 1.1em;
          text-align: center;
          width: 100%;
          margin-bottom: 15px !important;
        }

        /* Search and export section */
        .card > div:first-child > div {
          width: 100% !important;
          max-width: 100% !important;
          justify-content: center !important;
        }

        /* Action buttons in table */
        .btn-group {
          display: flex;
          flex-wrap: wrap;
          gap: 5px;
          justify-content: center;
        }

        .btn-group .btn {
          padding: 5px 8px;
          font-size: 12px;
        }
      }

      /* Extra small devices */
      @media (max-width: 480px) {
        .dashboard-header {
          padding: 10px 10px 15px;
        }

        .dashboard-header .logo {
          font-size: 18px !important;
        }

        .user-controls button {
          max-width: 100%;
          padding: 10px 15px;
          font-size: 13px;
        }

        .stat-card {
          padding: 15px;
        }

        .stat-number {
          font-size: 1.5em;
        }

        .stat-label {
          font-size: 0.85em;
        }

        .card {
          padding: 12px;
          border-radius: 8px;
        }

        .modal-content-custom {
          padding: 15px;
        }

        .table-custom th,
        .table-custom td {
          padding: 8px 5px;
          font-size: 12px;
        }
      }
    </style>
  </head>

  <body>
    <div id="app"></div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay">
      <div class="modal-content-custom">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0; color: var(--primary); font-weight: 700">
            Edit User
          </h3>
          <button
            onclick="closeModal('editModal')"
            style="
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <input type="hidden" id="edit_id" />
        <div class="form-group">
          <label style="font-weight: 600; color: var(--muted)">Full Name</label>
          <input id="edit_name" class="form-control" />
        </div>
        <div class="form-group">
          <label style="font-weight: 600; color: var(--muted)">Email</label>
          <input id="edit_email" class="form-control" />
        </div>
        <div class="form-group">
          <label style="font-weight: 600; color: var(--muted)">Phone</label>
          <input id="edit_phone" class="form-control" />
        </div>
        <div class="form-group">
          <label style="font-weight: 600; color: var(--muted)">Class</label>
          <select id="edit_class" class="form-control">
            <option value="7">7th Standard</option>
            <option value="8">8th Standard</option>
            <option value="9">9th Standard</option>
            <option value="10">10th Standard</option>
            <option value="11">11th Standard</option>
          </select>
        </div>
        <div style="text-align: right; margin-top: 25px">
          <button
            class="btn btn-default"
            onclick="closeModal('editModal')"
            style="margin-right: 10px"
          >
            Cancel
          </button>
          <button class="btn btn-primary-custom" onclick="saveEdit()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
      <div class="modal-content-custom" style="text-align: center">
        <div
          style="
            width: 60px;
            height: 60px;
            background: #fee2e2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
          "
        >
          <i class="fa fa-trash" style="font-size: 24px; color: #ef4444"></i>
        </div>
        <h3 style="margin-top: 0; color: #1f2937; font-weight: 700">
          Delete User?
        </h3>
        <p style="color: #6b7280; margin-bottom: 25px">
          Are you sure you want to delete this user? This action cannot be
          undone.
        </p>
        <input type="hidden" id="delete_id" />
        <div style="display: flex; gap: 10px; justify-content: center">
          <button
            class="btn btn-default"
            onclick="closeModal('deleteModal')"
            style="flex: 1"
          >
            Cancel
          </button>
          <button
            class="btn btn-danger-custom"
            onclick="confirmDelete()"
            style="flex: 1"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal-overlay">
      <div
        class="modal-content-custom"
        style="text-align: center; max-width: 400px"
      >
        <div class="success-icon-wrapper">
          <i class="fa fa-check"></i>
        </div>
        <h3 style="margin: 0 0 10px; color: var(--primary); font-weight: 700">
          Success!
        </h3>
        <p id="successMessage" style="color: var(--muted); margin-bottom: 25px">
          Operation completed successfully.
        </p>
        <button
          class="btn btn-primary-custom"
          onclick="closeModal('successModal')"
          style="width: 100%; border-radius: 30px"
        >
          Continue
        </button>
      </div>
    </div>

    <!-- Create Admin Modal -->
    <div id="createAdminModal" class="modal-overlay">
      <div class="modal-content-custom">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0; color: var(--primary); font-weight: 700">
            Create New Admin
          </h3>
          <button
            onclick="closeModal('createAdminModal')"
            style="
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <div class="form-group">
          <label style="font-weight: 600; color: var(--muted)">Email</label>
          <input
            id="new_admin_email"
            type="email"
            class="form-control"
            placeholder="admin@example.com"
          />
        </div>
        <div class="form-group">
          <label style="font-weight: 600; color: var(--muted)">Password</label>
          <input
            id="new_admin_pass"
            type="password"
            class="form-control"
            placeholder="********"
          />
        </div>
        <div style="text-align: right; margin-top: 25px">
          <button
            class="btn btn-default"
            onclick="closeModal('createAdminModal')"
            style="margin-right: 10px"
          >
            Cancel
          </button>
          <button class="btn btn-primary-custom" onclick="createAdmin()">
            Create Admin
          </button>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal-overlay">
      <div
        class="modal-content-custom"
        style="text-align: center; max-width: 400px"
      >
        <div class="success-icon-wrapper" style="background: #fee2e2">
          <i class="fa fa-times" style="color: #ef4444"></i>
        </div>
        <h3 style="margin: 0 0 10px; color: #ef4444; font-weight: 700">
          Error
        </h3>
        <p id="errorMessage" style="color: var(--muted); margin-bottom: 25px">
          Something went wrong.
        </p>
        <button
          class="btn btn-danger-custom"
          onclick="closeModal('errorModal')"
          style="width: 100%; border-radius: 30px"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-overlay">
      <div class="modal-content-custom" style="max-width: 600px">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0; color: var(--primary); font-weight: 700">
            Manage Progress
          </h3>
          <button
            onclick="closeModal('progressModal')"
            style="
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <input type="hidden" id="progress_user_id" />
        <div
          id="courseListContainer"
          style="max-height: 400px; overflow-y: auto"
        >
          <!-- Courses will be injected here -->
        </div>
        <div style="text-align: right; margin-top: 25px">
          <button
            class="btn btn-default"
            onclick="closeModal('progressModal')"
            style="margin-right: 10px"
          >
            Close
          </button>
          <button class="btn btn-primary-custom" onclick="saveProgress()">
            Save Progress
          </button>
        </div>
      </div>
    </div>

    <script>
      // ---------- Utilities ----------
      const qs = (s) => document.querySelector(s);
      const qsa = (s) => Array.from(document.querySelectorAll(s));

      // Initialize Superadmin
      const initSuperAdmin = () => {
        const admin = JSON.parse(localStorage.getItem("super_admin") || "null");
        // Force update to new password if it doesn't match or doesn't exist
        if (!admin || admin.password !== "admin@123") {
          localStorage.setItem(
            "super_admin",
            JSON.stringify({
              email: "superadmin@successplanet.com",
              password: "admin@123",
            })
          );
        }
      };
      initSuperAdmin();

      const saveUsers = (users) =>
        localStorage.setItem("ls_users", JSON.stringify(users));
      const loadUsers = () => {
        let users = JSON.parse(localStorage.getItem("ls_users") || "[]");

        // Migration check for single user registration from register.html
        const singleUser = localStorage.getItem("userData");
        if (singleUser) {
          try {
            const u = JSON.parse(singleUser);
            // Check if this user is already in our list
            if (!users.some((existing) => existing.email === u.email)) {
              u.id = Date.now();
              u.verified = false;
              users.push(u);
              saveUsers(users); // Save back to list
            }
          } catch (e) {}
        }
        return users;
      };

      // ---------- Routing ----------
      function navigate(route) {
        location.hash = route;
      }
      function currentRoute() {
        return location.hash.replace("#", "") || "/admin-login";
      }

      window.addEventListener("hashchange", render);
      window.addEventListener("load", () => {
        render();
      });

      // ---------- Views ----------

      function viewAdminLogin() {
        return `
          <div class="container">
            <div class="card login-box animate-fade-in">
              <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: var(--primary); font-weight: bold;">Admin Login</h2>
                <p class="text-muted">Secure Access for Administrators</p>
              </div>
              <div class="form-group">
                <label>Email Address</label>
                <input id="admin_email" type="email" class="form-control" placeholder="example@gmail.com" />
              </div>
              <div class="form-group">
                <label>Password</label>
                <input id="admin_pass" type="password" class="form-control" placeholder="••••••••" />
              </div>
              <button class="btn btn-custom btn-block" onclick="handleAdminLogin()">
                <i class="fa fa-lock"></i> Login to Dashboard
              </button>
              <div style="margin-top: 20px; text-align: center;">
                <a href="index.html" style="color: var(--primary);">Back to Home</a>
              </div>
            </div>
          </div>
        `;
      }

      function viewAdminDashboard() {
        const users = loadUsers();
        const total = users.length;
        const verified = users.filter((u) => u.verified).length;
        const pending = total - verified;

        // Check if current user is Superadmin to show "Create Admin" button
        const currentUser = JSON.parse(
          sessionStorage.getItem("current_admin") || "{}"
        );
        const isSuperAdmin = currentUser.role === "superadmin";

        return `
          <div style="background: var(--primary); color: white; padding: 15px 0; margin-bottom: 30px;">
            <div class="container">
              <div class="dashboard-header">
                <div class="logo">Success Planet <span style="font-size: 0.6em; background: var(--accent); color: #333; padding: 2px 6px; border-radius: 4px; vertical-align: middle;">ADMIN</span></div>
                <div class="user-controls">
                  ${
                    isSuperAdmin
                      ? `<button class="btn btn-custom" onclick="openCreateAdminModal()"><i class="fa fa-plus"></i> Create Admin</button>`
                      : ""
                  }
                  <button class="btn btn-danger-custom" onclick="logout()"><i class="fa fa-sign-out"></i> Logout</button>
                </div>
              </div>
            </div>
          </div>

          <div class="container animate-fade-in">
            <div class="row">
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-number">${total}</div>
                  <div class="stat-label">Total Users</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-number" style="color: #4caf50;">${verified}</div>
                  <div class="stat-label">Verified Users</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-number" style="color: #ff9800;">${pending}</div>
                  <div class="stat-label">Pending Verification</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin: 0; color: var(--primary);">User Management</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%; max-width: 400px; justify-content: flex-end;">
                   <input id="searchBox" class="form-control" placeholder="Search users..." style="flex-grow: 1;" oninput="renderTable()" />
                   <button class="btn btn-primary-custom" onclick="exportExcel()"><i class="fa fa-download"></i> Export</button>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-hover table-custom" id="userTable">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Class</th>
                      <th>Courses</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- Admin Management Container -->
            <div id="adminManagementContainer"></div>
          </div>
        `;
      }

      // ---------- Logic ----------

      function render() {
        const route = currentRoute();
        const app = document.getElementById("app");

        if (route === "/admin-login") {
          app.innerHTML = viewAdminLogin();
        } else if (route === "/dashboard") {
          if (!isAuthenticated()) {
            navigate("/admin-login");
            return;
          }
          app.innerHTML = viewAdminDashboard();
          renderTable();
          renderAdminManagement(); // Render admin list if superadmin
        } else {
          navigate("/admin-login");
        }
      }

      function isAuthenticated() {
        return sessionStorage.getItem("admin_session") === "true";
      }

      function handleAdminLogin() {
        const email = qs("#admin_email").value;
        const pass = qs("#admin_pass").value;

        // Check Superadmin
        const superAdmin = JSON.parse(localStorage.getItem("super_admin"));
        if (email === superAdmin.email && pass === superAdmin.password) {
          sessionStorage.setItem("admin_session", "true");
          sessionStorage.setItem(
            "current_admin",
            JSON.stringify({ email: email, role: "superadmin" })
          );
          navigate("/dashboard");
          return;
        }

        // Check Regular Admins
        const admins = JSON.parse(localStorage.getItem("ls_admins") || "[]");
        const foundAdmin = admins.find(
          (a) => a.email === email && a.password === pass
        );

        if (foundAdmin) {
          if (foundAdmin.isActive === false) {
            showError(
              "Your account has been deactivated. Please contact Superadmin."
            );
            return;
          }
          sessionStorage.setItem("admin_session", "true");
          sessionStorage.setItem(
            "current_admin",
            JSON.stringify({ email: email, role: "admin" })
          );
          navigate("/dashboard");
        } else {
          showError("Invalid credentials!");
        }
      }

      function logout() {
        sessionStorage.removeItem("admin_session");
        sessionStorage.removeItem("current_admin");
        navigate("/admin-login");
      }

      // Admin Creation Logic
      function openCreateAdminModal() {
        qs("#new_admin_email").value = "";
        qs("#new_admin_pass").value = "";
        qs("#createAdminModal").classList.add("active");
      }

      function createAdmin() {
        const email = qs("#new_admin_email").value;
        const pass = qs("#new_admin_pass").value;

        if (!email || !pass) {
          showError("Please fill in all fields");
          return;
        }

        const admins = JSON.parse(localStorage.getItem("ls_admins") || "[]");
        if (admins.some((a) => a.email === email)) {
          showError("Admin with this email already exists");
          return;
        }

        // Add isActive: true by default
        admins.push({
          email,
          password: pass,
          role: "admin",
          createdAt: Date.now(),
          isActive: true,
        });
        localStorage.setItem("ls_admins", JSON.stringify(admins));

        closeModal("createAdminModal");
        showSuccess("New Admin created successfully!");
        renderAdminManagement(); // Refresh list
      }

      function renderAdminManagement() {
        const currentUser = JSON.parse(
          sessionStorage.getItem("current_admin") || "{}"
        );
        if (currentUser.role !== "superadmin") return;

        const container = qs("#adminManagementContainer");
        if (!container) return;

        // Inject the HTML structure if not present
        if (!qs("#adminTable")) {
          container.innerHTML = `
              <div class="card" style="margin-top: 30px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h3 style="margin: 0; color: var(--primary);">Admin Management</h3>
                  </div>
                  <div class="table-responsive">
                      <table class="table table-hover table-custom" id="adminTable">
                          <thead>
                              <tr>
                                  <th>Email</th>
                                  <th>Role</th>
                                  <th>Created At</th>
                                  <th>Status</th>
                                  <th>Actions</th>
                              </tr>
                          </thead>
                          <tbody></tbody>
                      </table>
                  </div>
              </div>
           `;
        }

        const tbody = qs("#adminTable tbody");
        const admins = JSON.parse(localStorage.getItem("ls_admins") || "[]");

        if (admins.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">No other admins created yet.</td></tr>';
          return;
        }

        tbody.innerHTML = admins
          .map(
            (admin, index) => `
            <tr>
                <td>${admin.email}</td>
                <td><span class="badge" style="background:#e0e0e0; color:#333;">Admin</span></td>
                <td>${new Date(admin.createdAt).toLocaleDateString()}</td>
                <td>
                    ${
                      admin.isActive !== false
                        ? '<span class="badge-verified">Active</span>'
                        : '<span class="badge-pending" style="background:#ef4444;">Inactive</span>'
                    }
                </td>
                <td>
                    <button class="btn btn-sm ${
                      admin.isActive !== false
                        ? "btn-danger-custom"
                        : "btn-success"
                    }" 
                            onclick="toggleAdminStatus(${index})"
                            data-tooltip="${
                              admin.isActive !== false
                                ? "Deactivate"
                                : "Activate"
                            }">
                        <i class="fa ${
                          admin.isActive !== false ? "fa-ban" : "fa-check"
                        }"></i>
                        ${admin.isActive !== false ? "Deactivate" : "Activate"}
                    </button>
                </td>
            </tr>
        `
          )
          .join("");
      }

      function toggleAdminStatus(index) {
        const admins = JSON.parse(localStorage.getItem("ls_admins") || "[]");
        if (admins[index]) {
          // Toggle status (default is true if undefined)
          const currentStatus = admins[index].isActive !== false;
          admins[index].isActive = !currentStatus;

          localStorage.setItem("ls_admins", JSON.stringify(admins));
          renderAdminManagement();
          showSuccess(
            `Admin ${
              admins[index].isActive ? "activated" : "deactivated"
            } successfully!`
          );
        }
      }

      function renderTable() {
        const tbody = qs("#userTable tbody");
        if (!tbody) return;

        const users = loadUsers();
        const q = qs("#searchBox").value.toLowerCase();

        const filtered = users.filter(
          (u) =>
            (u.name || u.fullName || "").toLowerCase().includes(q) ||
            (u.email || "").toLowerCase().includes(q)
        );

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">No users found</td></tr>';
          return;
        }

        tbody.innerHTML = filtered
          .map(
            (u) => `
          <tr>
            <td><strong>${u.name || u.fullName}</strong></td>
            <td>${u.email}</td>
            <td>${u.class || "N/A"}</td>
            <td>
                <span class="badge" style="background: #e0e0e0; color: #333;">${
                  (u.enrolledCourses || []).length
                } Enrolled</span>
            </td>
            <td>
              ${
                u.verified
                  ? '<span class="badge-verified">Verified</span>'
                  : '<span class="badge-pending">Pending</span>'
              }
            </td>
            <td>
              <div class="btn-group">
                ${
                  !u.verified
                    ? `<button class="btn btn-sm btn-success action-btn" data-tooltip="Verify User" onclick="verifyUser(${u.id})"><i class="fa fa-check"></i></button>`
                    : ""
                }
                <button class="btn btn-sm btn-info action-btn" data-tooltip="Edit User" onclick="openEditModal(${
                  u.id
                })"><i class="fa fa-pencil"></i></button>
                <button class="btn btn-sm btn-warning action-btn" data-tooltip="Manage Progress" onclick="openProgressModal(${
                  u.id
                })"><i class="fa fa-bar-chart"></i></button>
                <button class="btn btn-sm btn-danger action-btn" data-tooltip="Delete User" onclick="openDeleteModal(${
                  u.id
                })"><i class="fa fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Action Handlers
      function verifyUser(id) {
        const users = loadUsers();
        const user = users.find((u) => u.id === id);
        if (user) {
          user.verified = true;
          saveUsers(users);
          renderTable();
          render(); // Update stats
          showSuccess("User verified successfully!");
        }
      }

      function openEditModal(id) {
        const users = loadUsers();
        const user = users.find((u) => u.id === id);
        if (!user) return;

        qs("#edit_id").value = id;
        qs("#edit_name").value = user.name || user.fullName;
        qs("#edit_email").value = user.email;
        qs("#edit_phone").value = user.phone || "";
        qs("#edit_class").value = user.class || "7";

        qs("#editModal").classList.add("active");
      }

      function saveEdit() {
        const id = Number(qs("#edit_id").value);
        const users = loadUsers();
        const user = users.find((u) => u.id === id);

        if (user) {
          user.name = qs("#edit_name").value;
          user.fullName = qs("#edit_name").value; // syncing both fields
          user.email = qs("#edit_email").value;
          user.phone = qs("#edit_phone").value;
          user.class = qs("#edit_class").value;

          saveUsers(users);
          closeModal("editModal");
          renderTable();
          showSuccess("User details updated successfully!");
        }
      }

      function openDeleteModal(id) {
        qs("#delete_id").value = id;
        qs("#deleteModal").classList.add("active");
      }

      function confirmDelete() {
        const id = Number(qs("#delete_id").value);
        let users = loadUsers();
        users = users.filter((u) => u.id !== id);
        saveUsers(users);
        closeModal("deleteModal");
        render(); // Re-render to update stats
        showSuccess("User deleted successfully!");
      }

      function closeModal(id) {
        qs("#" + id).classList.remove("active");
      }

      // Progress Management
      function openProgressModal(id) {
        const users = loadUsers();
        const user = users.find((u) => u.id === id);
        if (!user) return;

        qs("#progress_user_id").value = id;
        const container = qs("#courseListContainer");
        container.innerHTML = "";

        const courses = user.enrolledCourses || [];

        if (courses.length === 0) {
          container.innerHTML =
            '<p class="text-center text-muted" style="padding: 20px;">User has not enrolled in any courses yet.</p>';
        } else {
          courses.forEach((course, index) => {
            // Handle both string and object formats
            const name = typeof course === "string" ? course : course.name;
            const progress =
              typeof course === "string" ? 0 : course.progress || 0;

            container.innerHTML += `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent);">
                  <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                      <strong style="font-size:1.1em;">${name}</strong>
                      <span class="badge" style="background: #e0e0e0; color: #333;">${progress}% Completed</span>
                  </div>
                  <div class="form-group" style="margin-bottom:0;">
                      <label style="font-size:0.9em; color:var(--muted);">Update Progress (0-100%)</label>
                      <div style="display:flex; gap:10px;">
                          <input type="range" class="form-control" min="0" max="100" value="${progress}" 
                              oninput="document.getElementById('prog_val_${index}').innerText = this.value + '%'; document.getElementById('prog_input_${index}').value = this.value;" 
                              style="flex:1;">
                          <span id="prog_val_${index}" style="width:40px; font-weight:bold; line-height:35px;">${progress}%</span>
                          <input type="hidden" id="prog_input_${index}" value="${progress}" class="course-progress-input" data-course-name="${name}">
                      </div>
                  </div>
              </div>
           `;
          });
        }

        qs("#progressModal").classList.add("active");
      }

      function saveProgress() {
        const id = Number(qs("#progress_user_id").value);
        const users = loadUsers();
        const user = users.find((u) => u.id === id);

        if (user) {
          const inputs = qsa(".course-progress-input");

          // Convert old string courses to objects if needed
          let updatedCourses = [];

          inputs.forEach((input) => {
            const name = input.getAttribute("data-course-name");
            const progress = Number(input.value);

            updatedCourses.push({
              id: name.toLowerCase().replace(/\s+/g, "-"),
              name: name,
              progress: progress,
              status: progress >= 100 ? "Completed" : "In Progress",
              enrolledDate: new Date().toISOString(), // Preserving original date would be better but this is a simple fix
            });
          });

          // Only update if there were courses
          if (updatedCourses.length > 0) {
            user.enrolledCourses = updatedCourses;
            saveUsers(users);
            showSuccess("Progress updated successfully!");
            closeModal("progressModal");
          } else {
            closeModal("progressModal");
          }
        }
      }

      function showSuccess(msg) {
        qs("#successMessage").textContent = msg;
        qs("#successModal").classList.add("active");
      }

      function showError(msg) {
        qs("#errorMessage").textContent = msg;
        qs("#errorModal").classList.add("active");
      }

      function exportExcel() {
        const users = loadUsers();
        let content = "Name\tEmail\tPhone\tClass\tStatus\n";
        users.forEach((u) => {
          content += `${u.name || u.fullName}\t${u.email}\t${u.phone || ""}\t${
            u.class || ""
          }\t${u.verified ? "Verified" : "Pending"}\n`;
        });

        const blob = new Blob([content], { type: "application/vnd.ms-excel" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "success_planet_users.xls";
        a.click();
      }
    </script>
  </body>
</html>
